#!/usr/bin/env python
import argparse
import csv
import sys
import time
from datetime import datetime

def format_timestamp(timestamp):
    return datetime.fromtimestamp(timestamp).strftime('%Y-%m-%d %H:%M:%S')

def format_log_tsv(t, message):
    return "{}\t{}".format(t, message)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description="""
        Logs messages with timestamps to CSV file.
        """,
    )
    parser.add_argument(
        '-r','--read',
        help="File to read from",
        type=argparse.FileType('r'),
        default=sys.stdin
    )
    parser.add_argument(
        '-w','--write',
        help="File to write to",
        # Create an append file cursor
        type=argparse.FileType('a'),
        default=sys.stdout
    )
    parser.add_argument(
        '-m','--message',
        help="Message to write to file",
        default=None
    )
    args = parser.parse_args()
    writefile = args.write
    t = format_timestamp(time.time())

    # Use message flag if present. Otherwise use file/stdout.
    if args.message:
        writefile.write(format_log_tsv(t, args.message))
    else:
        readfile = args.read
        for line in readfile:
            writefile.write(format_log_tsv(t, line))